import { useEffect, useRef, useState } from "react";
import { createLrcObj, LrcObj } from "react-lrcplayer";
import style from './index.module.scss'
import { useGSAP } from "@gsap/react";
import gsap from "gsap";
import { getNextItem, getPreviousItem, getRangeWithRadius, transformL2Lrc, transformLineLrc } from "@/data/visualize-player/utils";
gsap.registerPlugin(useGSAP);

const baseLrc = `[ti:提瓦特民谣 星空版]
[ar:鹿喑kana & 多多poi & Mace & 陶典 & 孙晔 & 花玲]
[00:10.41]<00:10.41>船 <00:11.06>摇<00:11.44>啊<00:11.74>摇<00:12.42>
[00:12.42]<00:12.42>摇<00:12.74>到<00:13.05>陌<00:13.53>生<00:13.70>的<00:14.26>远<00:14.39>方 <00:14.69>摇<00:14.98>断<00:15.11>了<00:15.27>船<00:15.53>桨<00:16.24>
[00:16.24]<00:16.24>进<00:16.57>土<00:16.93>壤 <00:17.62>长<00:17.91>成<00:18.25>了<00:18.73>愿<00:18.87>望<00:19.38>和<00:19.53>新<00:19.84>故<00:20.14>乡<00:20.85>
[00:20.85]<00:20.85>我<00:21.51>的<00:21.83>朋<00:22.16>友<00:22.78>
[00:22.78]<00:22.78>你<00:23.12>在<00:23.45>哪 <00:23.99>是<00:24.12>否<00:24.65>凝<00:24.80>望<00:25.10>同<00:25.40>一<00:25.54>轮<00:25.68>月<00:26.04>光<00:26.70>
[00:26.70]<00:26.70>有<00:27.06>没<00:27.35>有 <00:27.99>成<00:28.31>为<00:28.66>期<00:29.12>待<00:29.28>的<00:29.79>英<00:29.93>雄<00:30.24>模<00:30.55>样<00:30.89>
[00:30.89]<00:30.89>(Nzuri <00:31.24>Sana)<00:34.93>
[00:40.34]<00:40.34>Nzuri <00:41.00>Sana<00:41.66>
[00:41.66]<00:41.66>风 <00:42.32>绕<00:42.68>啊<00:43.01>绕<00:43.64>
[00:43.64]<00:43.64>绕<00:43.99>成<00:44.36>年<00:44.80>轮<00:44.97>记<00:45.43>录<00:45.58>西<00:45.93>山<00:46.24>来<00:46.40>的<00:46.54>歌<00:46.86>谣<00:47.56>
[00:47.56]<00:47.56>轻<00:47.91>唱<00:48.23>着 <00:48.87>十<00:49.19>八<00:49.54>万<00:49.99>个<00:50.14>寂<00:50.68>静<00:50.83>的<00:51.15>夜<00:51.47>色<00:52.10>
[00:52.10]<00:52.10>我<00:52.79>的<00:53.16>朋<00:53.47>友<00:54.12>
[00:54.12]<00:54.12>若<00:54.43>岁<00:54.79>月<00:55.25>是<00:55.40>一<00:55.89>条<00:56.03>能<00:56.35>够<00:56.73>逆<00:57.02>流<00:57.17>的<00:57.34>河<00:58.04>
[00:58.04]<00:58.04>你<00:58.34>是<00:58.67>否 <00:59.31>还<00:59.63>会<01:00.00>踏<01:00.48>上<01:00.62>未<01:01.11>知<01:01.24>的<01:01.56>远<01:01.92>走<01:02.60>
[01:02.60]<01:02.60>Hakunamatata <01:03.86>my <01:04.21>friend<01:05.14>
[01:05.14]<01:05.14>绽<01:05.42>放<01:05.60>吧<01:05.84>异<01:06.11>世<01:06.25>界<01:06.51>的<01:06.79>花<01:07.12>蕾<01:07.77>
[01:07.77]<01:07.77>Hakunamatata <01:09.05>my <01:09.38>friend<01:10.32>
[01:10.32]<01:10.32>命<01:10.62>运<01:10.82>的<01:11.03>恩<01:11.34>惠<01:11.70>从<01:11.86>未<01:12.17>走<01:12.34>远<01:12.95>
[01:12.95]<01:12.95>Latata!Latata!<01:15.40>
[01:15.40]<01:15.40>从<01:15.64>繁<01:15.83>花<01:16.12>到<01:16.27>深<01:16.47>渊<01:16.74>从<01:16.91>白<01:17.11>昼<01:17.39>到<01:17.55>夜<01:18.20>
[01:18.20]<01:18.20>净<01:18.39>土<01:18.68>将<01:18.87>歌<01:19.13>颂<01:19.36>你<01:19.54>崇<01:19.75>高<01:19.98>的<01:20.17>灵<01:20.42>魂<01:20.65>到<01:20.85>永<01:21.48>远<01:22.12> <01:22.66>永<01:22.79>远<01:23.40>
[01:23.40]<01:23.40>船 <01:24.04>摇<01:24.38>啊<01:24.70>摇<01:25.36>
[01:25.36]<01:25.36>摇<01:25.69>到<01:26.06>太<01:26.49>阳<01:26.67>下<01:27.19>班<01:27.35>月<01:27.66>儿<01:28.00>挂<01:28.31>树<01:28.65>梢<01:29.27>
[01:29.27]<01:29.27>歇<01:29.58>歇<01:29.89>脚 <01:30.60>默<01:30.90>念<01:31.25>早<01:31.71>睡<01:31.90>早<01:32.37>起<01:32.54>身<01:32.88>体<01:33.23>好<01:33.86>
[01:33.86]<01:33.86>我<01:34.52>的<01:34.86>朋<01:35.20>友<01:35.83>
[01:35.83]<01:35.83>要<01:36.15>是<01:36.44>累<01:36.96>了<01:37.13>病<01:37.57>了<01:37.77>找<01:38.11>我<01:38.45>瞧<01:38.75>一<01:39.13>瞧<01:39.76>
[01:39.76]<01:39.76>不<01:40.12>得<01:40.42>了 <01:41.11>三<01:41.39>丘<01:41.53>丘<01:41.78>快<01:42.19>采<01:42.35>药<01:42.68>让<01:43.02>四<01:43.27>丘<01:43.42>丘<01:43.61>熬<01:44.35>
[01:44.35]<01:44.35>Hakunamatata <01:45.65>my <01:45.95>friend<01:46.97>
[01:46.97]<01:46.97>森<01:47.23>林<01:47.40>里<01:47.56>传<01:47.85>来<01:48.02>可<01:48.18>爱<01:48.48>回<01:48.80>响<01:49.55>
[01:49.55]<01:49.55>Hakunamatata <01:49.71>my <01:50.50>friend<01:52.01>
[01:52.01]<01:52.01>见<01:52.54>你<01:52.75>点<01:53.07>燃<01:53.41>勇<01:53.61>敢<01:53.90>的<01:54.08>火<01:54.39>把<01:54.72>
[01:54.72]<01:54.72>Latata!Latata!<01:57.11>
[01:57.11]<01:57.11>从<01:57.37>桓<01:57.55>那<01:57.83>兰<01:57.98>那<01:58.29>到<01:58.62>欧<01:58.85>庇<01:59.11>克<01:59.29>莱<01:59.53>呀<01:59.98>
[01:59.98]<01:59.98>地<02:00.19>脉<02:00.43>记<02:00.63>录<02:00.86>着<02:01.12>你<02:01.30>传<02:01.52>奇<02:01.75>的<02:01.97>诗<02:02.21>篇<02:02.44>到<02:02.63>永<02:03.19>远 <02:03.84>永<02:04.49>远<02:06.56>
[02:15.70]<02:15.70>船 <02:16.36>摇<02:16.68>啊<02:16.98>摇<02:17.62>
[02:17.62]<02:17.63>摇<02:17.94>到<02:18.29>陌<02:18.72>生<02:18.89>的<02:19.38>远<02:19.53>方<02:19.86>摇<02:20.19>断<02:20.37>了<02:20.51>船<02:20.83>桨<02:21.48>
[02:21.48]<02:21.48>进<02:21.84>土<02:22.15>壤 <02:22.80>长<02:23.13>成<02:23.46>了<02:23.91>愿<02:24.08>望<02:24.53>和<02:24.68>新<02:25.11>故<02:25.39>乡<02:26.04>
[02:26.04]<02:26.04>我<02:26.75>的<02:27.04>朋<02:27.29>友<02:28.01>
[02:28.01]<02:28.01>有<02:28.30>没<02:28.61>有<02:29.11>找<02:29.27>到<02:29.79>我<02:29.94>留<02:30.29>给<02:30.66>你<02:30.84>的<02:30.99>宝<02:31.29>藏<02:32.02>
[02:32.02]<02:32.02>在<02:32.32>这<02:32.64>里 <02:33.21>在<02:33.53>那<02:33.89>里<02:34.34>
[02:34.34]<02:34.34>哈<02:34.62>？<02:35.24>
[02:35.24]<02:35.24>在<02:35.52>哪<02:35.72>呢<02:37.05>
[02:37.05]<02:37.05>别<02:37.21>找<02:37.36>了<02:37.61>，<02:37.74>一<02:37.86>起<02:37.98>唱<02:38.12>吧<02:38.24>！<02:39.02>
[02:39.02]<02:39.02>船 <02:39.73>摇<02:40.06>啊<02:40.41>摇<02:41.06>
[02:41.06]<02:41.06>摇<02:41.41>到<02:41.72>陌<02:42.23>生<02:42.38>的<02:42.89>远<02:43.04>方<02:43.35>摇<02:43.67>断<02:43.83>了<02:43.98>船<02:44.27>桨<02:44.95>
[02:44.95]<02:44.95>进<02:45.28>土<02:45.62>壤 <02:46.23>长<02:46.57>成<02:46.91>了<02:47.39>愿<02:47.55>望<02:48.08>和<02:48.23>新<02:48.53>故<02:48.84>乡<02:49.54>
[02:49.54]<02:49.54>我<02:50.19>的<02:50.50>朋<02:50.84>友<02:51.44>
[02:51.44]<02:51.44>你<02:51.77>在<02:52.12>哪 <02:52.54>是<02:52.70>否<02:53.27>凝<02:53.45>望<02:53.78>同<02:54.08>一<02:54.24>轮<02:54.36>月<02:54.69>光<02:55.39>
[02:55.39]<02:55.39>有<02:55.77>没<02:56.08>有 <02:56.72>成<02:57.03>为<02:57.35>期<02:57.80>待<02:57.96>的<02:58.50>英<02:58.61>雄<02:58.97>模<02:59.30>样<02:59.99>
[02:59.99]<02:59.99>船 <03:00.66>摇<03:00.98>啊<03:01.29>摇 <03:01.88>摇<03:01.99>啊<03:02.29>摇<03:02.22>啊<03:02.54>摇<03:03.30>啊<03:03.62>摇<03:05.16>
[03:05.16]<03:05.16>风 <03:05.84>绕<03:06.17>啊<03:06.49>绕 <03:07.12>绕<03:07.42>啊<03:07.76>绕<03:08.29>啊<03:08.43>绕<03:08.74>啊<03:09.10>绕<03:10.40>
[03:10.40]<03:10.40>我<03:11.11>的<03:11.42>朋<03:11.73>友<03:12.40>
[03:12.40]<03:12.40>请<03:12.69>带<03:13.04>走<03:13.52>这<03:13.69>一<03:13.99>首<03:14.30>歌<03:15.63>
[03:15.63]<03:15.63>去<03:16.25>更<03:16.94>远<03:17.61>的<03:17.93>远<03:18.27>方<03:19.52>…<03:20.80>
[03:20.80]<03:20.80>HakunaMatata! <03:22.03>My <03:22.40>friend!<03:24.60>
[03:24.60]<03:24.61>荣<03:25.20>誉<03:25.36>骑<03:25.51>士<03:25.68>哥<03:25.82>哥<03:26.06>你<03:26.21>们<03:26.33>快<03:26.55>点<03:27.62>
[03:27.62]<03:27.62>小<03:27.74>可<03:27.88>莉<03:28.05>我<03:28.17>来<03:28.35>啦<03:28.72>！<03:29.02>宝<03:29.17>藏<03:29.28>宝<03:29.41>藏<03:29.53>…<03:29.76>
[03:29.76]<03:29.76>派<03:29.93>蒙<03:30.12>，<03:30.34>等<03:30.47>等<03:30.61>我<03:30.74>，<03:30.87>派<03:31.02>蒙<03:31.20>！<03:31.46>
[03:31.46]<03:31.46>吾<03:31.72>之<03:31.84>封<03:31.96>印<03:32.11>…<03:32.23>…<03:32.44>诶<03:32.61>！<03:32.71>还<03:32.83>有<03:32.95>我<03:33.11>!<03:33.40>`

// const baseLrc = createLrcObj(`[00:10:39]船_0_摇_111_啊_145_摇_181_
// [00:12:51]摇到_81_陌生_161_的_179_远方_244_摇断了_325_船桨_372_
// [00:16:37]进_0_土_71_壤_103_长_175_成_205_了_237_愿_282_望_300_和_347_新_363_故_393_乡_425_
// [00:20:95]我_0_的_165_朋_196_友_227_
// [00:22:91]你_0_在_128_哪_162_是_206_否_220_凝_268_望_283_同_317_一_351_轮_367_月_386_光_416_
// [00:26:81]有_0_没_114_有_145_成_209_为_242_期_277_待_321_的_336_英_388_雄_403_模_436_样_470_
// [00:31:00]Nzuri_0_Sana_38_
// [00:41:81]风_0_绕_149_啊_181_绕_214_
// [00:43:84]绕_0_成_114_年_146_轮_196_记_210_录_254_西_271_山_302_来_336_的_352_歌_368_谣_399_
// [00:47:69]轻_0_唱_100_着_132_十_200_八_231_万_264_个_311_寂_327_静_371_的_387_夜_421_色_454_
// [00:52:27]我_0_的_92_朋_123_友_156_
// [00:54:21]若_0_岁_53_月_87_是_132_一_148_条_195_能_212_够_248_逆_282_流_314_的_331_河_352_
// [00:58:16]你_0_是_50_否_77_还_145_会_176_踏_209_上_255_未_271_知_318_的_335_远_367_走_399_
// [01:02:67]Hakunamatata_0_my_198_friend_229_
// [01:05:25]绽_0_放_58_吧_74_异_96_世_124_界_140_的_157_花_188_蕾_222_
// [01:07:89]Hakunamatata_0_my_220_friend_252_
// [01:10:51]命_0_运_84_的_101_恩_119_惠_143_从_174_未_197_走_224_远_241_
// [01:13:08]Latata_0_Latata_137_
// [01:15:51]从_0_繁_69_花_86_到_114_深_129_渊_147_从_170_白_192_昼_213_到_241_夜_258_
// [01:18:25]净_0_土_43_将_72_歌_93_颂_110_你_131_崇_151_高_169_的_189_灵_213_魂_235_到_264_永_285_远_351_永_416_远_492_
// [01:23:45]船_0_摇_115_啊_148_摇_183_
// [01:25:51]摇_0_到_85_太_118_阳_163_下_179_班_223_月_238_儿_275_挂_307_树_339_梢_374_
// [01:29:42]歇_0_歇_73_脚_107_默_171_念_205_早_239_睡_293_早_308_起_355_身_370_体_402_好_433_
// [01:34:03]我_0_的_74_朋_102_友_136_
// [01:36:00]要_0_是_28_累_65_了_109_病_130_了_178_找_194_我_225_瞧_259_一_290_瞧_328_
// [01:39:87]不_0_得_121_了_156_三_226_丘_253_丘_269_快_286_采_326_药_341_让_377_四_410_丘_436_丘_452_熬_466_
// [01:44:42]Hakunamatata_0_my_55_friend_189_
// [01:46:96]森_0_林_130_里_145_传_167_来_194_可_211_爱_226_回_261_响_295_
// [01:49:63]Hakunamatata_0_my_193_friend_222_
// [01:52:17]见_0_你_68_点_84_燃_117_勇_151_敢_172_的_204_火_220_把_249_
// [01:54:87]Latata_0_Latata_219_
// [01:57:21]从_0_桓_46_那_67_兰_96_那_111_到_141_欧_172_庇_195_克_223_莱_241_呀_268_
// [02:00:03]地_0_脉_25_记_51_录_75_着_101_你_122_传_142_奇_164_的_189_诗_208_篇_230_到_253_永_327_远_353_永_383_远_442_
// [02:15:67]船_0_摇_136_啊_170_摇_205_
// [02:17:70]摇_0_到_103_陌_137_生_183_的_199_远_243_方_258_摇_291_断_324_了_340_船_363_桨_391_
// [02:21:57]进_0_土_91_壤_122_长_194_成_224_了_256_愿_307_望_321_和_367_新_380_故_408_乡_434_
// [02:26:06]我_0_的_82_朋_116_友_149_
// [02:28:14]有_0_没_44_有_81_找_121_到_134_我_179_留_195_给_230_你_262_的_278_宝_293_藏_325_
// [02:31:94]在_0_这_124_里_157_在_224_那_260_里_292_
// [02:34:52]哈_0_
// [02:35:31]在_0_哪_57_呢_75_
// [02:37:02]别_0_找_23_了_42_一_68_起_80_唱_92_吧_108_
// [02:39:14]船_0_摇_83_啊_113_摇_145_
// [02:41:16]摇_0_到_47_陌_74_生_117_的_131_远_179_方_192_摇_232_断_263_了_284_船_303_桨_332_
// [02:44:91]进_0_土_126_壤_160_长_220_成_257_了_295_愿_336_望_350_和_406_新_421_故_457_乡_489_
// [02:49:60]我_0_的_126_朋_157_友_186_
// [02:51:54]你_0_在_88_哪_121_是_163_否_179_凝_228_望_244_同_280_一_312_轮_329_月_345_光_376_
// [02:55:44]有_0_没_81_有_111_成_176_为_209_期_244_待_288_的_302_英_352_雄_368_模_397_样_426_
// [03:00:00]船_0_摇_63_啊_99_摇_130_摇_197_啊_228_摇_263_啊_313_摇_328_啊_359_摇_393_
// [03:05:26]风_0_绕_92_啊_122_绕_155_绕_221_啊_251_绕_285_啊_339_绕_353_啊_384_绕_412_
// [03:10:50]我_0_的_114_朋_143_友_176_
// [03:12:36]请_0_带_72_走_107_这_153_一_167_首_201_歌_234_
// [03:15:72]去_0_更_134_远_198_的_262_远_293_方_328_
// [03:19:72]HakunaMatata_0_My_309_friend_341_
// [03:25:46]荣_0_誉_58_骑_73_士_90_哥_105_哥_122_你_136_们_148_快_167_点_188_
// [03:27:47]小_0_可_66_莉_84_我_114_来_127_啦_139_宝_176_藏_193_宝_217_藏_231_
// [03:30:00]派_0_蒙_14_等_31_等_48_我_65_派_90_蒙_103_
// [03:31:69]吾_0_之_81_封_97_印_123_诶_138_还_159_有_177_我_206_
// `);

const lrc = transformLineLrc(createLrcObj(baseLrc));
// const lrc = transformL2Lrc(baseLrc);


export default function LineByLinePlayer() {
    const audio = useRef(null);
    const [currentLine, setCurrentLine] = useState(0);
    const [currentOffset, setCurrentOffset] = useState(0);
    const [currentTime, setCurrentTime] = useState(0);
    function onTimeUpdate() {
        const currentTime = audio.current?.currentTime || 0;
        setCurrentTime(currentTime);
        const currentLine = lrc.findIndex(m => m.time >= currentTime - 0.3) - 1;
        setCurrentLine(currentLine);

        const currentOffset = lrc[currentLine]?.line?.findIndex(f => f.time >= currentTime - 0.3);
        setCurrentOffset(currentOffset);
        requestAnimationFrame(onTimeUpdate);
    }

    useEffect(() => {
        // console.log(lrc);
        if (audio.current) {
            onTimeUpdate();
        }
    }, []);

    // useEffect(() => { console.log(lrc[currentLine]?.line.filter(f => f.time >= currentTime).map(m => m.content)) }, [currentOffset])

    // useGSAP(() => {
    //     gsap.fromTo('span[data-active="true"]', {
    //         // x: 10,
    //         opacity: 0.3,
    //     }, {
    //         // x: 0,
    //         opacity: 1,
    //         duration: 0.5,
    //         ease: "power1.inOut",
    //     })
    // }, [currentLine])

    return <div>
        <div className={style["lyric"]}>
            <span className={style['line']}>
                {/* {getRangeWithRadius(lrc, currentLine, 3).map((m, i) => <span
                    key={`${m.line}-${m.time}`}
                    className="line-lrc"
                    // data-index={i}
                    data-active={m.time < getNextItem(lrc, currentLine).time && m.time > getPreviousItem(lrc, currentLine).time}
                >
                    {m.line.map(l => l.content)}
                </span>)} */}
                {/* {lrc[currentLine]?.line?.map((m, i) => (
                    <span
                        key={`${i}-${m.time}`}
                        data-active={i <= currentOffset}
                    >
                        {m.content}
                    </span>
                ))} */}

                {lrc[currentLine]?.line?.map((m, i) => (
                    <span
                        key={`${i}-${m.time}`}
                        data-active={i <= currentOffset}
                    >
                        {m.content}
                    </span>
                ))}

            </span>
            {/* <span className={style['lrc']}>
                {lrc[currentLine]?.line?.map((m, i) => (
                    <span>
                        {m.content}
                    </span>
                ))}
            </span> */}
        </div>
        <audio
            ref={audio}
            src="https://res.arsrna.cn/audios/%E9%B9%BF%E5%96%91kana%20&%20%E5%A4%9A%E5%A4%9Apoi%20&%20Mace%20&%20%E9%99%B6%E5%85%B8%20&%20%E5%AD%99%E6%99%94%20&%20%E8%8A%B1%E7%8E%B2%20-%20%E6%8F%90%E7%93%A6%E7%89%B9%E6%B0%91%E8%B0%A3%20%E6%98%9F%E7%A9%BA%E7%89%88.mp3"
            controls
            className="w-full"
        />
    </div>
}